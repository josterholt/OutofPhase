<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style type="text/css">
        body {
            overflow:hidden;
        }
    </style>

    <script src="js/phaser.js"></script>
    <script src="js/objects.js"></script>
    <script src="js/triggers.js"></script>
    <script src="js/player.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/client.js"></script>
    <script src="js/attacks.js"></script>
    <script src="js/mobs.js"></script>
    <script src="js/game.js"></script>
    <script>
    var PLAYER_INDX;
    var PLAYER_NUM;
    var isConnected = false;
    var SERVER_STATE = {"data": { "players": [] }};
    var CLIENT = new Client();
    var REMOTE_EVENTS = [];
    var ws;

    var pieces = document.cookie.split(";");
    for(i in pieces) {
        if(pieces[i].indexOf("player") != -1) {
            PLAYER_NUM = pieces[i].split("=")[1];
            PLAYER_INDX = PLAYER_NUM - 1;
        }
    }

    if(PLAYER_INDX == undefined) {
        PLAYER_INDX = 1;
        PLAYER_NUM = 2;
        CURRENT_PLAYER_INDEX = PLAYER_INDX;
    }

    function updatePosition(x, y) {
        CLIENT.send(JSON.stringify({"action": "updatePlayerPosition", "x": x, "y": y}))
    }

    var com_update = function () {
        var requests = [];
        if(isConnected && CURRENT_PLAYER) {
            CLIENT.queueRequest({
                "action": "updatePlayer",
                "player": {
                    "position": [CURRENT_PLAYER.x, CURRENT_PLAYER.y],
                    "velocity": [CURRENT_PLAYER.body.velocity.x, CURRENT_PLAYER.body.velocity.y],
                    "facing": CURRENT_PLAYER.body.facing
                }
            });

            //ws.send(request);
            CLIENT.sendQueueMessages();
        }
    }

    window.onload = function() {
        ws = new WebSocket('ws://ubuntu:8888/websocket', ['soap', 'xmpp', 'binary']);

        ws.onopen = function () {
            if(PLAYER_NUM == 1) {
                console.debug("Create game...");
                if(localStorage['game_token'] != null) {
                    request = JSON.stringify([{ "action": "joinGame", "gameToken": localStorage['game_token'], "playerToken": localStorage['player_token']  }])
                } else {
                    request = JSON.stringify([{ "action": "createGame" }])
                }
            } else {
                if(localStorage['game_token'] == null) {
                    localStorage['game_token']  = prompt("Enter token")
                }

                if(localStorage['game_token'] != null) {
                    request = JSON.stringify([{ "action": "joinGame", "gameToken": localStorage['game_token'], "playerToken": localStorage['player_token']  }])
                }
            }
            isConnected = true;
            CLIENT.send(request)
        }

        ws.onerror = function (error) {
            console.debug('Websocket Error ' + error);
        }

        ws.onmessage = function (e) {
            if("data" in e) {
                var responses = JSON.parse(e.data);

                for(i in responses) {
                    var response = responses[i];

                    var action = null;
                    if(response.status != "OK") {
                        if(response.message == "Token is invalid" && PLAYER_NUM == 1) {
                            request = JSON.stringify([{ "action": "createGame" }])
                            CLIENT.send(request)
                        }
                    } else {

                        if ("data" in response && response.data != null && response.data != false && "action" in response.data) {
                            action = response.data.action;
                        }

                       //console.debug(action);
                        if (action == "INIT") {
                            if ("data" in response && response.data != null && response.data != false && "gameToken" in response.data) {
                                localStorage['game_token'] = response.data.gameToken;
                                prompt("Game Token", response.data.gameToken)
                            }

                            if (response.data != null && "playerToken" in response.data) {
                                localStorage['player_token'] = response.data.playerToken;
                            }

                            SERVER_STATE.status = "FRESH";
                            SERVER_STATE.data.players[0] = response.data.players[0];
                            SERVER_STATE.data.players[1] = response.data.players[1];
                            SERVER_STATE.data.mobs = response.data.mobs;
                            startGame();
                            window.setInterval(com_update, 100);
                        } else if (action == "UPDATE") {
                            if ("data" in response && response.data != null) {
                                SERVER_STATE.status = "FRESH";
                                SERVER_STATE.data.players[0] = response.data.players[0];
                                SERVER_STATE.data.players[1] = response.data.players[1];
                            }
                        } else if (action == "runTrigger") {
                            console.debug("Adding remote event");
                            REMOTE_EVENTS.push({"action": "TRIGGER", "data": response.data.data});
                        } else if(action == "updateObject") {
                            REMOTE_EVENTS.push({"action": "OBJECT", "data": response.data.data});
                        } else {
                            console.debug("Bad message, discarding")
                            console.debug(response)
                            console.debug(response.data)
                        }
                    }
                }
            }
        }
    }

    </script>
</head>
<body>

</body>
</html>