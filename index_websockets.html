<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <script src="js/phaser.min.js"></script>
    <script src="js/triggers.js"></script>
    <script src="js/utils.js"></script>
    <script type="text/javascript" src="js/game.js"></script>
    <script>
    var PLAYER_INDX;
    var PLAYER_NUM;
    var isConnected = false;
    var SERVER_STATE = {"data": { "players": [] }};
    var CLIENT = new Client();
    var REMOTE_EVENTS = [];
    var ws;

    var pieces = document.cookie.split(";");
    for(i in pieces) {
        if(pieces[i].indexOf("player") != -1) {
            PLAYER_NUM = pieces[i].split("=")[1];
            PLAYER_INDX = PLAYER_NUM - 1;
        }
    }

    if(PLAYER_INDX == undefined) {
        PLAYER_INDX = 1;
        PLAYER_NUM = 2;
        CURRENT_PLAYER_INDEX = PLAYER_INDX;
    }

    function updatePosition(x, y) {
        ws.send(JSON.stringify({"action": "updatePlayerPosition", "x": x, "y": y}))
    }

    var com_update = function () {
        if(isConnected && CURRENT_PLAYER) {
            var request = JSON.stringify({
                "action": "updatePlayer",
                "player": {
                    "position": [CURRENT_PLAYER.x, CURRENT_PLAYER.y],
                    "velocity": [CURRENT_PLAYER.body.velocity.x, CURRENT_PLAYER.body.velocity.y],
                    "facing": CURRENT_PLAYER.body.facing
                },

            });

            ws.send(request);
        }
    }

    window.onload = function() {
        ws = new WebSocket('ws://ubuntu:8888/websocket', ['soap', 'xmpp', 'binary']);

        ws.onopen = function () {
            if(PLAYER_NUM == 1) {
                console.debug("Create game...");
                if(localStorage['game_token'] != null) {
                    request = JSON.stringify({ "action": "joinGame", "gameToken": localStorage['game_token'], "playerToken": localStorage['player_token']  })
                } else {
                    request = JSON.stringify({ "action": "createGame" })
                }
            } else {
                if(localStorage['game_token'] == null) {
                    localStorage['game_token']  = prompt("Enter token")
                }

                if(localStorage['game_token'] != null) {
                    request = JSON.stringify({ "action": "joinGame", "gameToken": localStorage['game_token'], "playerToken": localStorage['player_token']  })
                }
            }
            isConnected = true;
            ws.send(request)
        }

        ws.onerror = function (error) {
            console.debug('Websocket Error ' + error);
        }

        ws.onmessage = function (e) {
            if("data" in e) {
                var response = JSON.parse(e.data);
                var action = null;
                if(response.status != "OK") {
                    if(response.message == "Token is invalid" && PLAYER_NUM == 1) {
                        request = JSON.stringify({ "action": "createGame" })
                        ws.send(request)
                    }
                } else {
                    if("data" in response && response.data != null && "gameToken" in response.data) {
                        localStorage['game_token'] = response.data.gameToken;
                        prompt("Game Token", response.data.gameToken)
                    }

                    if(response.data != null && "playerToken" in response.data) {
                        localStorage['player_token'] = response.data.playerToken;
                    }

                    if("data" in response && response.data != null && "action" in response.data) {
                        action = response.data.action;
                    }

                    //console.debug(action);
                    if(action == "INIT") {
                        SERVER_STATE.status = "FRESH";
                        SERVER_STATE.data.players[0] = response.data.players[0];
                        SERVER_STATE.data.players[1] = response.data.players[1];
                        startGame();
                        window.setInterval(com_update, 100);
                    } else if(action == "UPDATE") {
                        if ("data" in response && response.data != null) {
                            SERVER_STATE.status = "FRESH";
                            SERVER_STATE.data.players[0] = response.data.players[0];
                            SERVER_STATE.data.players[1] = response.data.players[1];
                        }
                    } else if(action == "runTrigger") {
                        REMOTE_EVENTS.push(response.data.data)
                    } else {
                        console.debug("Bad message, discarding")
                    }
                }
            }
        }
    }

    </script>
</head>
<body>

</body>
</html>